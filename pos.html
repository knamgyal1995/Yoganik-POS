<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ìš”ê°€ë‹ˆí¬ POS">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-180.png">
  <title>ìš”ê°€ë‹ˆí¬ POS</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; overflow: hidden;
      -webkit-text-size-adjust: none;
      font-family: -apple-system, 'Apple SD Gothic Neo', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: #F4F6F8; color: #1A1A2E;
    }
    :root {
      --mint:    #8BC34A;
      --mint-d:  #7CB342;
      --mint-bg: #F1F8E9;
      --navy:    #1A1A2E;
      --bg:      #F4F6F8;
      --card:    #FFFFFF;
      --border:  #E9ECEF;
      --gray:    #6C757D;
      --red:     #E53E3E;
      --shadow:  0 2px 12px rgba(0,0,0,.07);
      --radius:  16px;
    }

    /* â”€â”€ App shell â”€â”€ */
    #app { display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Offline bar â”€â”€ */
    #offline-bar {
      background: var(--red); color: #fff;
      text-align: center; padding: 7px; font-size: 13px; font-weight: 600;
      display: none; flex-shrink: 0;
    }
    #offline-bar.on { display: block; }

    /* â”€â”€ Header â”€â”€ */
    #header {
      background: var(--navy); color: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 14px; min-height: 58px; flex-shrink: 0;
    }
    .h-brand { font-size: 17px; font-weight: 800; letter-spacing: -.5px; }
    .h-date  { font-size: 10px; opacity: .55; margin-top: 2px; }
    .h-right { display: flex; gap: 8px; align-items: center; }
    .h-stat  { text-align: right; }
    .h-stat-val { font-size: 15px; font-weight: 700; }
    .h-stat-lbl { font-size: 10px; opacity: .55; }
    .h-btn {
      background: rgba(255,255,255,.14); border: none; color: #fff;
      padding: 7px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .h-btn:active { background: rgba(255,255,255,.26); }

    /* â”€â”€ Main â”€â”€ */
    #main { flex: 1 1 0; min-height: 0; display: flex; overflow: hidden; }

    /* â”€â”€ Product panel â”€â”€ */
    #products-panel {
      flex: 1 1 0; min-width: 0; min-height: 0;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding: 14px 12px 100px;
    }
    #products-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    /* â”€â”€ Product card â”€â”€ */
    .p-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex; flex-direction: column;
      border: 2px solid transparent;
      transition: border-color .15s, box-shadow .15s, transform .08s;
      touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    .p-card.in-cart {
      border-color: var(--mint);
      box-shadow: 0 4px 16px rgba(139,195,74,.2);
    }
    .p-img-wrap {
      width: 100%; aspect-ratio: 1;
      background: #F0F0F0;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; flex-shrink: 0;
    }
    .p-img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .p-img-ph { font-size: 2.4em; line-height: 1; user-select: none; }
    .p-info { padding: 10px 10px 4px; flex: 1; }
    .p-name {
      font-size: 12px; font-weight: 700; line-height: 1.35;
      margin-bottom: 4px; white-space: pre-line; word-break: keep-all;
    }
    .p-price { font-size: 14px; font-weight: 800; color: var(--mint-d); }

    /* Inline qty controls */
    .p-qty-row {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; padding: 8px 10px 12px;
    }
    .btn-q {
      width: 34px; height: 34px; border-radius: 50%; border: none; color: #fff;
      font-size: 20px; font-weight: 700; line-height: 1;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      flex-shrink: 0; transition: opacity .1s, transform .08s;
    }
    .btn-q:active { transform: scale(.88); }
    .btn-q-m { background: #FF6B6B; }
    .btn-q-m:disabled { background: #CCC; cursor: not-allowed; transform: none; }
    .btn-q-p { background: var(--mint); }
    .qty-n { font-size: 16px; font-weight: 800; min-width: 22px; text-align: center; }

    /* â”€â”€ Cart panel â”€â”€ */
    #cart-panel {
      width: 290px; flex-shrink: 0; min-height: 0;
      background: var(--card); border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
      box-shadow: -4px 0 14px rgba(0,0,0,.05);
    }
    #cart-head {
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    #cart-head h2 { font-size: 15px; font-weight: 700; }
    #btn-clear {
      background: none; border: 1px solid var(--border); border-radius: 8px;
      padding: 5px 10px; font-size: 12px; color: var(--gray);
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    #cart-body {
      flex: 1 1 0; min-height: 0;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding: 8px 14px;
    }
    #cart-empty {
      height: 100%; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--gray); font-size: 13px; gap: 10px;
    }
    .cart-item { padding: 10px 0; border-bottom: 1px solid #F0F2F5; display: flex; align-items: center; gap: 10px; }
    .ci-thumb  { width: 40px; height: 40px; border-radius: 8px; background: #F0F0F0; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.4em; }
    .ci-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .ci-body   { flex: 1; min-width: 0; }
    .ci-name   { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .ci-row    { display: flex; align-items: center; justify-content: space-between; }
    .qty-wrap  { display: flex; align-items: center; gap: 6px; }
    .btn-q-sm  {
      width: 28px; height: 28px; border-radius: 50%; border: none; color: #fff;
      font-size: 16px; font-weight: 700; line-height: 1;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    .btn-q-sm:active { opacity: .75; }
    .btn-q-sm-m { background: #FF6B6B; }
    .btn-q-sm-p { background: var(--mint); }
    .qty-n-sm  { font-size: 14px; font-weight: 700; min-width: 18px; text-align: center; }
    .ci-sub    { font-size: 12px; font-weight: 700; color: var(--navy); }

    /* Cart footer */
    #cart-foot {
      padding: 14px 16px; border-top: 1px solid var(--border); flex-shrink: 0;
    }
    .disc-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .disc-row label { font-size: 12px; color: var(--gray); white-space: nowrap; }
    #disc-input {
      flex: 1; border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 10px; font-size: 14px; text-align: right; outline: none;
      -webkit-appearance: none; appearance: none;
    }
    #disc-input:focus { border-color: var(--mint); }
    .disc-row span { font-size: 12px; color: var(--gray); }
    .tot-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .tot-row .lbl { font-size: 12px; color: var(--gray); }
    .tot-row .amt { font-size: 13px; font-weight: 600; }
    .tot-row.main .lbl { font-size: 14px; font-weight: 700; color: var(--navy); }
    .tot-row.main .amt { font-size: 20px; font-weight: 800; color: var(--navy); }
    #btn-checkout {
      margin-top: 12px; width: 100%; padding: 16px;
      background: var(--mint); color: #fff; border: none;
      border-radius: var(--radius); font-size: 17px; font-weight: 800;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      transition: background .1s;
    }
    #btn-checkout:active   { background: var(--mint-d); }
    #btn-checkout:disabled { background: #BDC3C7; cursor: not-allowed; }

    /* â”€â”€ Collapsed mobile bar (cart-head on mobile, collapsed) â”€â”€ */
    #ch-collapsed {
      display: none;
      width: 100%; align-items: center; justify-content: space-between; gap: 12px;
    }
    .cmb-left { display: flex; align-items: center; gap: 8px; }
    .cmb-badge {
      background: var(--mint); color: #fff; border-radius: 50%;
      width: 22px; height: 22px; font-size: 12px; font-weight: 700;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .cmb-total { font-size: 15px; font-weight: 800; color: var(--navy); }
    #btn-charge-bar {
      padding: 10px 18px; background: var(--mint); color: #fff; border: none;
      border-radius: 24px; font-size: 14px; font-weight: 800;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      white-space: nowrap; flex-shrink: 0;
    }
    #btn-charge-bar:active   { background: var(--mint-d); }
    #btn-charge-bar:disabled { background: #BDC3C7; cursor: not-allowed; }

    /* â”€â”€ Modals â”€â”€ */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center;
      z-index: 200; padding: 16px;
    }
    .overlay.open { display: flex; }
    .modal {
      background: #fff; border-radius: 24px;
      padding: 28px 22px; width: 100%; max-width: 460px;
      max-height: 94vh; overflow-y: auto;
      box-shadow: 0 24px 60px rgba(0,0,0,.2);
      animation: popIn .18s ease;
      position: relative;
    }
    @keyframes popIn {
      from { opacity: 0; transform: scale(.94) translateY(12px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal h2 { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 20px; }
    .modal-close {
      position: absolute; top: 16px; right: 18px;
      background: #F0F0F0; border: none; border-radius: 50%;
      width: 30px; height: 30px; font-size: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Checkout modal â”€â”€ */
    .charge-total-box {
      background: linear-gradient(135deg, var(--mint) 0%, var(--mint-d) 100%);
      border-radius: 18px; padding: 22px; color: #fff;
      text-align: center; margin-bottom: 16px;
    }
    .ctb-label  { font-size: 12px; opacity: .85; margin-bottom: 8px; font-weight: 600; letter-spacing: .3px; }
    .ctb-amount { font-size: 38px; font-weight: 800; letter-spacing: -1px; }
    .charge-meta {
      background: #F8F9FA; border-radius: 12px; padding: 12px 14px;
      margin-bottom: 16px; font-size: 13px;
    }
    .cm-row { display: flex; justify-content: space-between; padding: 3px 0; color: var(--gray); }
    .cm-total {
      display: flex; justify-content: space-between;
      border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px;
      font-size: 14px; font-weight: 800; color: var(--navy);
    }
    .pay-tiles { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
    .pay-tile {
      width: 100%; padding: 17px 16px;
      border: 2px solid var(--border); border-radius: 14px;
      background: #fff; font-size: 16px; font-weight: 700;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; gap: 12px;
      transition: border-color .12s, background .12s;
      text-align: left;
    }
    .pay-tile.selected { border-color: var(--mint); background: var(--mint-bg); color: var(--mint-d); }
    .pay-tile:active   { opacity: .8; }
    .pay-tile-icon { font-size: 22px; }

    #qr-wrap { text-align: center; margin: 4px 0 16px; }
    #qr-img {
      width: 210px; height: 210px; object-fit: contain;
      border-radius: 14px; border: 2px solid var(--border); padding: 6px;
      display: block; margin: 0 auto; transform: rotate(90deg);
    }
    #qr-placeholder {
      width: 210px; height: 210px; border: 2px dashed var(--border);
      border-radius: 14px; margin: 0 auto;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--gray); font-size: 13px; gap: 8px;
    }
    .btn-ship {
      display: flex; align-items: center; gap: 8px;
      padding: 13px 14px; border: 1.5px dashed var(--border); border-radius: 12px;
      color: var(--gray); text-decoration: none; font-size: 13px; font-weight: 600;
      margin-bottom: 12px;
      touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      transition: border-color .12s, color .12s;
    }
    .btn-ship:active { border-color: var(--mint); color: var(--mint-d); }
    .btn-confirm {
      width: 100%; padding: 18px; background: var(--mint); color: #fff;
      border: none; border-radius: 14px; font-size: 17px; font-weight: 800;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
      margin-bottom: 10px; transition: background .1s;
    }
    .btn-confirm:active   { background: var(--mint-d); }
    .btn-confirm:disabled { background: #BDC3C7; cursor: not-allowed; font-size: 14px; }
    .btn-cancel {
      width: 100%; padding: 14px; background: none;
      border: 1px solid var(--border); border-radius: 14px;
      font-size: 14px; color: var(--gray);
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Summary modal â”€â”€ */
    .sum-grid   { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .sum-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 18px; }
    .sum-card { background: #F8F9FA; border-radius: 12px; padding: 14px; text-align: center; }
    .sum-card .sv { font-size: 17px; font-weight: 800; margin-bottom: 4px; }
    .sum-card .sl { font-size: 11px; color: var(--gray); }
    .tx-list { max-height: 260px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .tx-item { padding: 10px 0; border-bottom: 1px solid #F0F2F5; }
    .tx-top  { display: flex; justify-content: space-between; font-weight: 700; font-size: 13px; margin-bottom: 3px; }
    .tx-sub  { font-size: 11px; color: var(--gray); }
    .tx-pay  { font-size: 11px; color: var(--gray); margin-top: 2px; }
    .tx-item.refunded .tx-top { text-decoration: line-through; color: var(--gray); }
    .btn-refund {
      width: 100%; margin-top: 14px; padding: 13px;
      background: none; border: 1.5px solid var(--red); border-radius: 12px;
      color: var(--red); font-size: 14px; font-weight: 700;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    .btn-close-modal {
      width: 100%; margin-top: 10px; padding: 14px;
      background: var(--navy); color: #fff; border: none;
      border-radius: 12px; font-size: 14px; font-weight: 700;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Admin modal â”€â”€ */
    .admin-section-title {
      font-size: 11px; font-weight: 700; color: var(--gray);
      text-transform: uppercase; letter-spacing: .6px;
      margin-bottom: 10px;
    }
    .add-prod-form { display: flex; flex-direction: column; gap: 9px; margin-bottom: 12px; }
    .add-prod-form input {
      border: 1.5px solid var(--border); border-radius: 10px;
      padding: 13px; font-size: 15px; outline: none; -webkit-appearance: none; appearance: none;
    }
    .add-prod-form input:focus { border-color: var(--mint); }
    .btn-add-prod {
      width: 100%; padding: 15px; background: var(--mint); color: #fff;
      border: none; border-radius: 12px; font-size: 15px; font-weight: 800;
      cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    .btn-add-prod:active { background: var(--mint-d); }
    .admin-list {
      border: 1px solid var(--border); border-radius: 12px;
      overflow: hidden; margin-bottom: 16px;
    }
    .admin-list-empty { text-align: center; color: var(--gray); font-size: 13px; padding: 18px; }
    .admin-item {
      display: flex; align-items: center; padding: 11px 12px;
      border-bottom: 1px solid var(--border); font-size: 13px;
    }
    .admin-item:last-child { border-bottom: none; }
    .ai-name { font-weight: 600; flex: 1; }
    .ai-price { color: var(--mint-d); font-weight: 700; margin: 0 8px; font-size: 12px; }
    .btn-del {
      background: none; border: 1px solid var(--red); border-radius: 7px;
      color: var(--red); padding: 4px 9px; font-size: 11px; font-weight: 600;
      cursor: pointer; touch-action: manipulation; flex-shrink: 0;
    }
    /* Image manager */
    .img-mgr-item {
      display: flex; align-items: center; gap: 8px; padding: 9px 0;
      border-bottom: 1px solid var(--border);
    }
    .img-mgr-item:last-child { border-bottom: none; }
    .img-thumb {
      width: 36px; height: 36px; border-radius: 8px; background: #F0F0F0;
      flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-size: 1.1em;
    }
    .img-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .img-prod-name { font-size: 12px; font-weight: 600; flex: 1; min-width: 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .img-url-input {
      border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 8px; font-size: 11px; outline: none; width: 120px; -webkit-appearance: none; appearance: none;
    }
    .img-url-input:focus { border-color: var(--mint); }

    #toast {
      position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%);
      background: var(--navy); color: #fff;
      padding: 12px 24px; border-radius: 28px;
      font-size: 14px; font-weight: 700;
      z-index: 999; pointer-events: none;
      opacity: 0; transition: opacity .25s; white-space: nowrap;
    }
    #toast.show { opacity: 1; }

    /* â”€â”€ Mobile responsive â”€â”€ */
    @media (max-width: 640px) {
      #products-panel { padding-bottom: 88px; }

      #cart-panel {
        position: fixed; bottom: 0; left: 0; right: 0;
        width: 100%; max-height: 82vh;
        border-radius: 22px 22px 0 0; border-left: none;
        border-top: 1px solid var(--border);
        z-index: 80;
        transform: translateY(calc(100% - 70px));
        transition: transform .3s cubic-bezier(.4,0,.2,1);
        box-shadow: 0 -6px 30px rgba(0,0,0,.1);
      }
      #cart-panel.mobile-open { transform: translateY(0); }

      #cart-head {
        position: relative; padding: 20px 16px 14px; cursor: pointer;
        flex-direction: column; gap: 0; align-items: stretch;
      }
      #cart-head::before {
        content: ''; display: block; width: 36px; height: 4px;
        background: var(--border); border-radius: 2px;
        position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      }
      /* Collapsed: show the charge bar */
      #ch-collapsed { display: flex; }
      #ch-expanded  { display: none; }
      #cart-panel.mobile-open #ch-collapsed { display: none; }
      #cart-panel.mobile-open #ch-expanded  { display: flex; align-items: center; justify-content: space-between; width: 100%; }

      #cart-foot { padding: 10px 14px; }
      .disc-row  { display: none; }
      #cart-panel.mobile-open .disc-row { display: flex; }
      #products-grid { gap: 8px; }
      .p-name { font-size: 11px; }
      .p-price { font-size: 13px; }
    }

    @media (min-width: 641px) {
      #ch-collapsed { display: none !important; }
      #ch-expanded  { display: flex; align-items: center; justify-content: space-between; width: 100%; }
      #products-grid { grid-template-columns: repeat(3, 1fr); }
    }

    ::-webkit-scrollbar       { width: 3px; }
    ::-webkit-scrollbar-thumb { background: #DDD; border-radius: 3px; }
  </style>
</head>
<body>
<div id="app">

  <div id="offline-bar">ì˜¤í”„ë¼ì¸ â€” ê±°ë˜ê°€ ì €ì¥ë˜ì–´ ì˜¨ë¼ì¸ ì‹œ ìë™ ì „ì†¡ë©ë‹ˆë‹¤</div>

  <div id="header">
    <div>
      <div class="h-brand">ğŸŒ¿ ìš”ê°€ë‹ˆí¬</div>
      <div class="h-date" id="h-date"></div>
    </div>
    <div class="h-right">
      <div class="h-stat">
        <div class="h-stat-val" id="daily-total">â‚©0</div>
        <div class="h-stat-lbl">ì˜¤ëŠ˜ ë§¤ì¶œ</div>
      </div>
      <button class="h-btn" onclick="openSummary()">ğŸ“Š</button>
      <button class="h-btn" onclick="openAdmin()">âš™ï¸</button>
      <button class="h-btn" onclick="document.getElementById('qr-file-input').click()">ğŸ–¼ï¸</button>
      <input id="qr-file-input" type="file" accept="image/*" style="display:none" onchange="saveQRImage(event)">
    </div>
  </div>

  <div id="main">
    <div id="products-panel">
      <div id="products-grid"></div>
    </div>

    <div id="cart-panel">
      <div id="cart-head">
        <!-- Mobile collapsed bar -->
        <div id="ch-collapsed">
          <div class="cmb-left">
            <div class="cmb-badge" id="cmb-badge">0</div>
            <span class="cmb-total" id="cmb-total">â‚©0</span>
          </div>
          <button id="btn-charge-bar" onclick="event.stopPropagation(); openCheckout()" disabled>ê²°ì œí•˜ê¸°</button>
        </div>
        <!-- Desktop / expanded header -->
        <div id="ch-expanded">
          <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>
          <button id="btn-clear" onclick="clearCart()">ë¹„ìš°ê¸°</button>
        </div>
      </div>
      <div id="cart-body">
        <div id="cart-empty">
          <span style="font-size:34px">ğŸ›ï¸</span>
          ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”
        </div>
      </div>
      <div id="cart-foot">
        <div class="disc-row">
          <label>í• ì¸</label>
          <input id="disc-input" type="number" inputmode="numeric" placeholder="0" min="0" oninput="renderFooter(); updateMobileBar(); saveCart()">
          <span>ì›</span>
        </div>
        <div class="tot-row">
          <span class="lbl">ì†Œê³„</span>
          <span class="amt" id="subtotal-disp">â‚©0</span>
        </div>
        <div class="tot-row" id="disc-disp-row" style="display:none">
          <span class="lbl">í• ì¸</span>
          <span class="amt" style="color:var(--red)" id="disc-disp">-â‚©0</span>
        </div>
        <div class="tot-row main">
          <span class="lbl">í•©ê³„</span>
          <span class="amt" id="total-disp">â‚©0</span>
        </div>
        <button id="btn-checkout" onclick="openCheckout()" disabled>ê²°ì œí•˜ê¸°</button>
      </div>
    </div>
  </div>

</div><!-- #app -->


<!-- CHECKOUT MODAL -->
<div class="overlay" id="ov-checkout">
  <div class="modal">
    <button class="modal-close" onclick="closeOverlay('ov-checkout')">âœ•</button>
    <h2>ê²°ì œ</h2>

    <div class="charge-total-box">
      <div class="ctb-label">ê²°ì œ ê¸ˆì•¡</div>
      <div class="ctb-amount" id="ctb-amount">â‚©0</div>
    </div>

    <div class="charge-meta" id="charge-meta"></div>

    <div class="pay-tiles">
      <button class="pay-tile" id="tile-toss" onclick="setPayMethod('TOSS')">
        <span class="pay-tile-icon">ğŸ“±</span> TOSS
      </button>
      <button class="pay-tile" id="tile-card" onclick="setPayMethod('CARD')">
        <span class="pay-tile-icon">ğŸ’³</span> ì¹´ë“œ ê²°ì œ
      </button>
      <button class="pay-tile" id="tile-cash" onclick="setPayMethod('CASH')">
        <span class="pay-tile-icon">ğŸ’µ</span> í˜„ê¸ˆ ê²°ì œ
      </button>
    </div>

    <div id="qr-wrap" style="display:none">
      <img id="qr-img" src="" alt="QR" style="display:none">
      <div id="qr-placeholder">
        <span style="font-size:44px">ğŸ“·</span>
        <span style="font-size:12px;color:var(--gray)">í—¤ë”ì˜ ğŸ–¼ï¸ ë²„íŠ¼ìœ¼ë¡œ QRì„ ë“±ë¡í•˜ì„¸ìš”</span>
      </div>
    </div>

    <a href="https://forms.gle/kzpgpV3r8uYr1FxcA" target="_blank" rel="noopener" class="btn-ship">
      <span>ğŸ“¦</span> íƒë°° ë°°ì†¡? ë°°ì†¡ ì •ë³´ ì…ë ¥í•˜ê¸°
    </a>

    <button class="btn-confirm" id="btn-confirm-pay" onclick="confirmPayment()" disabled>
      ê²°ì œ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”
    </button>
    <button class="btn-cancel" onclick="closeOverlay('ov-checkout')">ì·¨ì†Œ</button>
  </div>
</div>


<!-- SUMMARY MODAL -->
<div class="overlay" id="ov-summary">
  <div class="modal">
    <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ ë§¤ì¶œ</h2>
    <div class="sum-grid">
      <div class="sum-card"><div class="sv" id="s-total">â‚©0</div><div class="sl">ì´ ë§¤ì¶œ</div></div>
      <div class="sum-card"><div class="sv" id="s-count">0</div><div class="sl">ê±°ë˜ ìˆ˜</div></div>
    </div>
    <div class="sum-grid-3">
      <div class="sum-card"><div class="sv" id="s-toss">â‚©0</div><div class="sl">TOSS</div></div>
      <div class="sum-card"><div class="sv" id="s-card">â‚©0</div><div class="sl">ì¹´ë“œ</div></div>
      <div class="sum-card"><div class="sv" id="s-cash">â‚©0</div><div class="sl">í˜„ê¸ˆ</div></div>
    </div>
    <h3 style="font-size:12px;color:var(--gray);margin-bottom:8px">ê±°ë˜ ë‚´ì—­</h3>
    <div class="tx-list" id="tx-list"></div>
    <button class="btn-refund"      onclick="refundLast()">â†© ë§ˆì§€ë§‰ ê±°ë˜ ì·¨ì†Œ</button>
    <button class="btn-close-modal" onclick="closeOverlay('ov-summary')">ë‹«ê¸°</button>
  </div>
</div>


<!-- ADMIN MODAL -->
<div class="overlay" id="ov-admin">
  <div class="modal">
    <button class="modal-close" onclick="closeOverlay('ov-admin')">âœ•</button>
    <h2>âš™ï¸ ìƒí’ˆ ê´€ë¦¬</h2>

    <div class="admin-section-title">ìƒˆ ìƒí’ˆ ì¶”ê°€</div>
    <div class="add-prod-form">
      <input id="admin-prod-name"  type="text"   placeholder="ìƒí’ˆëª…" autocomplete="off">
      <input id="admin-prod-price" type="number" inputmode="numeric" placeholder="ê°€ê²© (ì›)" min="0" autocomplete="off">
      <input id="admin-prod-img"   type="url"    placeholder="ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)" autocomplete="off">
    </div>
    <button class="btn-add-prod" onclick="addProduct()">+ ìƒí’ˆ ì¶”ê°€</button>

    <div class="admin-section-title" style="margin-top:20px">ì¶”ê°€ëœ ìƒí’ˆ</div>
    <div id="admin-prod-list"></div>

    <div class="admin-section-title" style="margin-top:20px">ìƒí’ˆ ì´ë¯¸ì§€ ê´€ë¦¬</div>
    <div id="admin-img-mgr"></div>
  </div>
</div>


<div id="toast"></div>


<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONFIG = {
  SHEETS_URL: 'https://script.google.com/macros/s/AKfycbw2TFk-YlWpA3riFfAWws4AsDKEI2-JyA8jGiDsJh7BRTMUVKJSU-lzLdnrvqcOydzllA/exec',
};

// â”€â”€ Default products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_PRODUCTS = [
  { id: 1,  name: 'ì¸ì„¼ìŠ¤\n(ìëª½)',               price: 16000  },
  { id: 2,  name: 'ì¸ì„¼ìŠ¤\n(ê·¸ë¦°í‹°)',             price: 16000  },
  { id: 3,  name: 'íŒ”ë¡œì‚°í† \n5 SET',              price: 10500  },
  { id: 4,  name: 'ì„¸íŠ¸ìƒí’ˆ\n(ì¸ì„¼ìŠ¤+íŒ”ë¡œì‚°í† )',  price: 25000  },
  { id: 5,  name: 'ì‹±ì‰ë³¼ XS',                   price: 107000 },
  { id: 6,  name: 'ì‹±ì‰ë³¼ S',                    price: 137000 },
  { id: 7,  name: 'ì‹±ì‰ë³¼ M',                    price: 167000 },
  { id: 8,  name: 'ì¸ì„¼ìŠ¤_ìŠ¤íƒ€í„°',               price: 2000   },
  { id: 9,  name: 'íŒ”ë¡œì‚°í† _ìŠ¤íƒ€í„°',             price: 2000   },
  { id: 10, name: 'ë§Œë‹¬ë¼',                      price: 90000  },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let customProducts  = loadCustomProducts();
let productImages   = loadProductImages();
let cart            = {};
let payMethod       = 'TOSS';
let txList          = loadTx();

function allProducts() { return [...DEFAULT_PRODUCTS, ...customProducts]; }

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KRW = n => 'â‚©' + Math.max(0, n).toLocaleString('ko-KR');
const pad = n  => String(n).padStart(2, '0');
function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function now() {
  const d = new Date();
  return { date: todayKey(), time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` };
}
function dateLabel() {
  const d = new Date(), day = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
  return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${day})`;
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function toast(msg, ms = 2200) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(el._t); el._t = setTimeout(() => el.classList.remove('show'), ms);
}
function nextProductId() {
  const n = (parseInt(localStorage.getItem('yn_pid') || '1000') + 1);
  localStorage.setItem('yn_pid', n);
  return n;
}

// â”€â”€ localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTx()            { try { return JSON.parse(localStorage.getItem('yn_tx_' + todayKey()) || '[]'); } catch { return []; } }
function saveTx()            { localStorage.setItem('yn_tx_' + todayKey(), JSON.stringify(txList)); }
function loadPending()       { try { return JSON.parse(localStorage.getItem('yn_pending') || '[]'); } catch { return []; } }
function savePending(a)      { localStorage.setItem('yn_pending', JSON.stringify(a)); }
function loadCustomProducts(){ try { return JSON.parse(localStorage.getItem('yn_custom_products') || '[]'); } catch { return []; } }
function saveCustomProducts(){ localStorage.setItem('yn_custom_products', JSON.stringify(customProducts)); }
function loadProductImages() { try { return JSON.parse(localStorage.getItem('yn_prod_images') || '{}'); } catch { return {}; } }
function saveProductImages() { localStorage.setItem('yn_prod_images', JSON.stringify(productImages)); }
function saveCart() {
  const disc = parseInt(document.getElementById('disc-input').value) || 0;
  localStorage.setItem('yn_cart', JSON.stringify({ items: cart, discount: disc }));
}
function loadSavedCart() {
  try {
    const d = JSON.parse(localStorage.getItem('yn_cart') || '{}');
    return { items: d.items || {}, discount: d.discount || 0 };
  } catch { return { items: {}, discount: 0 }; }
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stats() {
  const a = txList.filter(t => !t.refunded);
  return {
    total: a.reduce((s,t) => s + t.total, 0),
    count: a.length,
    toss:  a.filter(t => t.pay === 'TOSS' || t.pay === 'QR').reduce((s,t) => s + t.total, 0),
    card:  a.filter(t => t.pay === 'CARD').reduce((s,t) => s + t.total, 0),
    cash:  a.filter(t => t.pay === 'CASH' || t.pay === 'í˜„ê¸ˆ').reduce((s,t) => s + t.total, 0),
  };
}
function updateHeader() {
  document.getElementById('daily-total').textContent = KRW(stats().total);
}

// â”€â”€ Cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subtotal() {
  return Object.entries(cart).reduce((sum, [id, qty]) => {
    const p = allProducts().find(p => p.id === +id);
    return sum + (p ? p.price * qty : 0);
  }, 0);
}
function discount() {
  const v = parseInt(document.getElementById('disc-input').value) || 0;
  return Math.min(v, subtotal());
}
function total() { return Math.max(0, subtotal() - discount()); }

function changeQty(id, delta) {
  const q = (cart[id] || 0) + delta;
  if (q < 0) return;
  if (q === 0) delete cart[id]; else cart[id] = q;
  saveCart();
  renderQtyOnCards();
  renderCartItems();
  renderFooter();
  updateMobileBar();
  if (delta > 0 && window.innerWidth <= 640) openMobileCart();
}

function clearCart() {
  cart = {};
  document.getElementById('disc-input').value = '';
  saveCart();
  renderProducts();
  renderCartItems();
  renderFooter();
  updateMobileBar();
}

function renderCartItems() {
  const body  = document.getElementById('cart-body');
  const empty = document.getElementById('cart-empty');
  [...body.children].forEach(c => { if (c !== empty) c.remove(); });

  if (Object.keys(cart).length === 0) {
    empty.style.display = 'flex';
  } else {
    empty.style.display = 'none';
    Object.entries(cart).forEach(([id, qty]) => {
      const p = allProducts().find(p => p.id === +id);
      if (!p) return;
      const imgSrc = productImages[p.id] || '';
      const el = document.createElement('div');
      el.className = 'cart-item';
      el.innerHTML = `
        <div class="ci-thumb">
          ${imgSrc ? `<img src="${imgSrc}" onerror="this.style.display='none'">` : p.name.charAt(0)}
        </div>
        <div class="ci-body">
          <div class="ci-name">${p.name.replace('\n', ' ')}</div>
          <div class="ci-row">
            <div class="qty-wrap">
              <button class="btn-q-sm btn-q-sm-m" onclick="changeQty(${id},-1)">âˆ’</button>
              <span class="qty-n-sm">${qty}</span>
              <button class="btn-q-sm btn-q-sm-p" onclick="changeQty(${id},+1)">+</button>
            </div>
            <span class="ci-sub">${KRW(p.price * qty)}</span>
          </div>
        </div>`;
      body.appendChild(el);
    });
  }
}

function renderFooter() {
  const sub = subtotal(), disc = discount(), tot = total();
  document.getElementById('subtotal-disp').textContent = KRW(sub);
  document.getElementById('total-disp').textContent    = KRW(tot);
  const dr = document.getElementById('disc-disp-row');
  if (disc > 0) { dr.style.display = 'flex'; document.getElementById('disc-disp').textContent = '-' + KRW(disc); }
  else          { dr.style.display = 'none'; }
  document.getElementById('btn-checkout').disabled = Object.keys(cart).length === 0;
}

function updateMobileBar() {
  const count = Object.values(cart).reduce((s, v) => s + v, 0);
  const tot   = total();
  document.getElementById('cmb-badge').textContent = count;
  document.getElementById('cmb-total').textContent = KRW(tot);
  const btn = document.getElementById('btn-charge-bar');
  if (btn) btn.disabled = count === 0;
}

// â”€â”€ Products grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProducts() {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = '';
  allProducts().forEach(p => {
    const qty    = cart[p.id] || 0;
    const imgSrc = productImages[p.id] || '';
    const el     = document.createElement('div');
    el.className = 'p-card' + (qty > 0 ? ' in-cart' : '');
    el.id        = 'p-' + p.id;
    el.innerHTML = `
      <div class="p-img-wrap">
        ${imgSrc ? `<img class="p-img" src="${imgSrc}" onerror="this.style.display='none';document.getElementById('ph-${p.id}').style.display='flex'">` : ''}
        <div class="p-img-ph" id="ph-${p.id}" style="display:${imgSrc ? 'none' : 'flex'}">ğŸŒ¿</div>
      </div>
      <div class="p-info">
        <div class="p-name">${p.name}</div>
        <div class="p-price">${KRW(p.price)}</div>
      </div>
      <div class="p-qty-row">
        <button class="btn-q btn-q-m" onclick="changeQty(${p.id},-1)" ${qty === 0 ? 'disabled' : ''}>âˆ’</button>
        <span class="qty-n" id="qty-${p.id}">${qty}</span>
        <button class="btn-q btn-q-p" onclick="changeQty(${p.id},+1)">+</button>
      </div>`;
    grid.appendChild(el);
  });
}

function renderQtyOnCards() {
  allProducts().forEach(p => {
    const card = document.getElementById('p-' + p.id);
    if (!card) return;
    const qty   = cart[p.id] || 0;
    const qtyEl = document.getElementById('qty-' + p.id);
    if (qtyEl) qtyEl.textContent = qty;
    card.classList.toggle('in-cart', qty > 0);
    const minus = card.querySelector('.btn-q-m');
    if (minus) minus.disabled = qty === 0;
  });
}

// â”€â”€ QR image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveQRImage(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => { localStorage.setItem('yn_qr', e.target.result); toast('âœ“ QR ì´ë¯¸ì§€ ì €ì¥ë¨'); };
  reader.readAsDataURL(file);
}
function loadStoredQR() {
  const stored = localStorage.getItem('yn_qr');
  const img = document.getElementById('qr-img'), ph = document.getElementById('qr-placeholder');
  if (stored) { img.src = stored; img.style.display = 'block'; ph.style.display = 'none'; }
  else        { img.style.display = 'none'; ph.style.display = 'flex'; }
}

// â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCheckout() {
  if (Object.keys(cart).length === 0) return;
  loadStoredQR();

  const items = Object.entries(cart).map(([id, qty]) => {
    const p = allProducts().find(p => p.id === +id);
    return { name: p.name.replace('\n', ' '), qty, price: p.price };
  });
  const disc = discount(), tot = total();

  document.getElementById('ctb-amount').textContent = KRW(tot);

  let meta = items.map(i => `<div class="cm-row"><span>${i.name} Ã— ${i.qty}</span><span>${KRW(i.price*i.qty)}</span></div>`).join('');
  if (disc > 0) meta += `<div class="cm-row"><span>í• ì¸</span><span style="color:var(--red)">-${KRW(disc)}</span></div>`;
  meta += `<div class="cm-total"><span>í•©ê³„</span><span>${KRW(tot)}</span></div>`;
  document.getElementById('charge-meta').innerHTML = meta;

  // Reset state
  const btn = document.getElementById('btn-confirm-pay');
  btn.disabled = true;
  btn.textContent = 'ê²°ì œ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”';
  ['TOSS','CARD','CASH'].forEach(m => document.getElementById('tile-'+m.toLowerCase()).classList.remove('selected'));
  document.getElementById('qr-wrap').style.display = 'none';
  // Pre-select last method for convenience
  setPayMethod(payMethod);

  openOverlay('ov-checkout');
}

function setPayMethod(m) {
  payMethod = m;
  ['TOSS','CARD','CASH'].forEach(method => {
    document.getElementById('tile-' + method.toLowerCase()).classList.toggle('selected', m === method);
  });
  document.getElementById('qr-wrap').style.display = (m === 'TOSS') ? 'block' : 'none';
  const labels = { TOSS: 'ğŸ“± TOSSë¡œ ê²°ì œ ì™„ë£Œ', CARD: 'ğŸ’³ ì¹´ë“œë¡œ ê²°ì œ ì™„ë£Œ', CASH: 'ğŸ’µ í˜„ê¸ˆìœ¼ë¡œ ê²°ì œ ì™„ë£Œ' };
  const btn = document.getElementById('btn-confirm-pay');
  btn.disabled    = false;
  btn.textContent = labels[m];
}

async function confirmPayment() {
  const btn = document.getElementById('btn-confirm-pay');
  if (btn.disabled) return;
  btn.disabled    = true;
  btn.textContent = 'â³ ì²˜ë¦¬ ì¤‘...';

  const t     = now();
  const items = Object.entries(cart).map(([id, qty]) => {
    const p = allProducts().find(p => p.id === +id);
    return { name: p.name.replace('\n', ' '), qty, price: p.price };
  });
  const disc = discount(), tot = total();
  const tx = {
    id: uid(), date: t.date, time: t.time,
    items, subtotal: subtotal(), discount: disc, total: tot,
    pay: payMethod, refunded: false,
  };

  txList.push(tx); saveTx(); updateHeader();

  try {
    await Promise.race([
      sendToSheets(tx),
      new Promise((_, rej) => setTimeout(() => rej('timeout'), 8000))
    ]);
  } catch { /* queued to pending */ }

  closeOverlay('ov-checkout');
  clearCart();
  toast('âœ“ ê²°ì œ ì™„ë£Œ! ' + KRW(tot));

  btn.disabled    = false;
  btn.textContent = 'ê²°ì œ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”';
}

// â”€â”€ Google Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendToSheets(tx) {
  if (!CONFIG.SHEETS_URL) return;
  const payload = {
    id: tx.id, date: tx.date, time: tx.time,
    items: tx.items.map(i => ({ name: i.name, qty: i.qty })), // array format for dynamic columns
    subtotal: tx.subtotal, discount: tx.discount,
    total: tx.total, payMethod: tx.pay,
  };
  try {
    const res = await fetch(CONFIG.SHEETS_URL, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    removePending(tx.id);
  } catch {
    const pending = loadPending();
    if (!pending.find(p => p.id === tx.id)) { pending.push(payload); savePending(pending); }
  }
}
function removePending(id)  { savePending(loadPending().filter(p => p.id !== id)); }
async function syncPending() {
  if (!CONFIG.SHEETS_URL) return;
  for (const payload of [...loadPending()]) {
    try {
      const res = await fetch(CONFIG.SHEETS_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload),
      });
      if (res.ok) removePending(payload.id);
    } catch { break; }
  }
}

// â”€â”€ Offline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateOnlineStatus() {
  const bar = document.getElementById('offline-bar');
  if (!navigator.onLine) { bar.classList.add('on'); }
  else                   { bar.classList.remove('on'); syncPending(); }
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// â”€â”€ Summary modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSummary() {
  const s = stats();
  document.getElementById('s-total').textContent = KRW(s.total);
  document.getElementById('s-count').textContent = s.count;
  document.getElementById('s-toss').textContent  = KRW(s.toss);
  document.getElementById('s-card').textContent  = KRW(s.card);
  document.getElementById('s-cash').textContent  = KRW(s.cash);
  const list = document.getElementById('tx-list'), all = [...txList].reverse();
  list.innerHTML = all.length === 0
    ? '<div style="text-align:center;color:var(--gray);padding:20px;font-size:13px">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'
    : all.map(t => `<div class="tx-item${t.refunded?' refunded':''}">
        <div class="tx-top"><span>${t.time}${t.refunded?' [ì·¨ì†Œ]':''}</span><span>${KRW(t.total)}</span></div>
        <div class="tx-sub">${t.items.map(i=>`${i.name} Ã—${i.qty}`).join(' / ')}</div>
        <div class="tx-pay">${t.pay}${t.discount>0?' | í• ì¸ '+KRW(t.discount):''}</div>
      </div>`).join('');
  openOverlay('ov-summary');
}
function refundLast() {
  const active = txList.filter(t => !t.refunded);
  if (!active.length) { toast('ì·¨ì†Œí•  ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  if (!confirm('ë§ˆì§€ë§‰ ê±°ë˜ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  active[active.length - 1].refunded = true;
  saveTx(); updateHeader(); openSummary(); toast('â†© ê±°ë˜ ì·¨ì†Œë¨');
}

// â”€â”€ Admin modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdmin() {
  document.getElementById('admin-prod-name').value  = '';
  document.getElementById('admin-prod-price').value = '';
  document.getElementById('admin-prod-img').value   = '';
  renderAdminProducts();
  renderImageManager();
  openOverlay('ov-admin');
}

function renderAdminProducts() {
  const container = document.getElementById('admin-prod-list');
  if (!customProducts.length) {
    container.innerHTML = '<div class="admin-list"><div class="admin-list-empty">ì¶”ê°€ëœ ìƒí’ˆ ì—†ìŒ</div></div>';
    return;
  }
  const list = document.createElement('div');
  list.className = 'admin-list';
  customProducts.forEach(p => {
    const el = document.createElement('div');
    el.className = 'admin-item';
    el.innerHTML = `<span class="ai-name">${p.name}</span><span class="ai-price">${KRW(p.price)}</span>
      <button class="btn-del" onclick="deleteProduct(${p.id})">ì‚­ì œ</button>`;
    list.appendChild(el);
  });
  container.innerHTML = '';
  container.appendChild(list);
}

function renderImageManager() {
  const container = document.getElementById('admin-img-mgr');
  container.innerHTML = '';
  allProducts().forEach(p => {
    const imgSrc = productImages[p.id] || '';
    const el = document.createElement('div');
    el.className = 'img-mgr-item';
    el.innerHTML = `
      <div class="img-thumb" id="ithumb-${p.id}">
        ${imgSrc ? `<img src="${imgSrc}" onerror="this.innerHTML='ğŸŒ¿'">` : 'ğŸŒ¿'}
      </div>
      <span class="img-prod-name">${p.name.replace('\n', ' ')}</span>
      <input class="img-url-input" type="url" placeholder="ì´ë¯¸ì§€ URL" value="${imgSrc}"
             onchange="saveProductImage(${p.id}, this.value.trim())">`;
    container.appendChild(el);
  });
}

function saveProductImage(id, url) {
  if (url) productImages[id] = url;
  else     delete productImages[id];
  saveProductImages();
  // Update thumb in admin
  const thumb = document.getElementById('ithumb-' + id);
  if (thumb) thumb.innerHTML = url ? `<img src="${url}" onerror="this.innerHTML='ğŸŒ¿'">` : 'ğŸŒ¿';
  renderProducts();
  toast('âœ“ ì´ë¯¸ì§€ ì €ì¥ë¨');
}

function addProduct() {
  const nameEl  = document.getElementById('admin-prod-name');
  const priceEl = document.getElementById('admin-prod-price');
  const imgEl   = document.getElementById('admin-prod-img');
  const name    = nameEl.value.trim();
  const price   = parseInt(priceEl.value) || 0;
  const imgUrl  = imgEl.value.trim();
  if (!name)     { toast('ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); nameEl.focus();  return; }
  if (price <= 0){ toast('ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”');   priceEl.focus(); return; }

  const id = nextProductId();
  customProducts.push({ id, name, price });
  if (imgUrl) productImages[id] = imgUrl;
  saveCustomProducts();
  saveProductImages();
  renderProducts();
  renderAdminProducts();
  renderImageManager();
  nameEl.value = ''; priceEl.value = ''; imgEl.value = '';
  toast('âœ“ ìƒí’ˆ ì¶”ê°€ë¨');

  if (CONFIG.SHEETS_URL) {
    fetch(CONFIG.SHEETS_URL, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'addProduct', productId: id, name, price, date: now().date }),
    }).catch(() => {});
  }
}

function deleteProduct(id) {
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  customProducts = customProducts.filter(p => p.id !== id);
  delete cart[id]; delete productImages[id];
  saveCart(); saveCustomProducts(); saveProductImages();
  renderProducts(); renderAdminProducts(); renderImageManager();
  toast('ìƒí’ˆ ì‚­ì œë¨');
}

// â”€â”€ Mobile cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isMobile()         { return window.innerWidth <= 640; }
function openMobileCart()   { if (isMobile()) document.getElementById('cart-panel').classList.add('mobile-open'); }
function toggleMobileCart() { if (isMobile()) document.getElementById('cart-panel').classList.toggle('mobile-open'); }

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openOverlay(id)  { document.getElementById(id).classList.add('open'); }
function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target === ov) closeOverlay(ov.id); });
});

// â”€â”€ Service worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); });
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const applyHeight = () => {
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.getElementById('app').style.height = h + 'px';
  };
  applyHeight();
  (window.visualViewport || window).addEventListener('resize', applyHeight);

  document.getElementById('h-date').textContent = dateLabel();
  document.getElementById('cart-head').addEventListener('click', toggleMobileCart);

  const saved = loadSavedCart();
  cart = saved.items;
  if (saved.discount) document.getElementById('disc-input').value = saved.discount;

  renderProducts();
  renderCartItems();
  renderFooter();
  updateMobileBar();
  updateHeader();
  updateOnlineStatus();
  loadStoredQR();

  // Daily reset check
  setInterval(() => {
    const k = todayKey();
    if (k !== window._lastDay) { txList = []; updateHeader(); window._lastDay = k; }
  }, 60_000);
  setInterval(() => { if (navigator.onLine) syncPending(); }, 30_000);
}

window._lastDay = todayKey();
init();
</script>
</body>
</html>
